{% extends "base.html" %}
{% load staticfiles %}
{% block content %}



    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="{% static "js/leaflet.ajax.min.js" %}"></script>

    <div class="col-lg-offset-1">
        <div>
            <label for="tasks">Filters</label>
            <select name="task" id="tasks">
                <option value="#">Filter by Tasks</option>
                <option value="supervision">Supervision</option>
                <option value="bcc">BCC</option>
                <option value="training">Training</option>
                <option value="new_distribution">New Distribution</option>
                <option value="iptp">IPTp</option>
                <option value="irs">IRS</option>
            </select>

            <select name="ip" id="ips">
                <option value="#">Filter by IPs</option>
                {% for ip in ips %}
                    <option value="{{ ip.id }}">{{ ip }}</option>

                {% endfor %}

            </select>
        </div>

    </div>
    <div id="map" class="col-lg-offset-1 col-lg-10" style="height: 600px"></div>



{% endblock %}


{% block js %}
    <script type="text/javascript">

        var map;
        var ajaxRequest;
        var plotlist;
        var plotlayers = [];
        var districts = [];
        var geojson;

        function initmap() {
            // set up the map
            map = new L.Map('map');

            var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var osmAttrib = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
            var osm = new L.TileLayer(osmUrl, {minZoom: 3, maxZoom: 18, attribution: osmAttrib});


            function style(feature) {
                return {
                    fillColor: '#536278',
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.5
                };
            }

            function style2(feature) {
                return {
                    fillColor: '#ccff3e',
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.5
                };
            }

            function style3(feature) {
                return {
                    fillColor: '#41ab5d',
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.5
                };
            }
            map.setView(new L.LatLng(1.395, 32.322), 7);
            map.addLayer(osm);
            $.getJSON("/static/js/districts.json", function (data) {
                var tiles = L.geoJson(data, {
                    style: style(),
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(feature.properties.name);
                        layer._polygonId = feature.id;
                    }

                });
                tiles.addTo(map)
            });
            $('#tasks').on('change', function (data) {
                if (map.hasLayer(geojson)) {
                    map.removeLayer(geojson);
                }
                $.getJSON("/task/" + $(this).val(), function (data) {
                    districts = data;
                    $.getJSON("/static/js/districts2.json", function (data) {
                        geojson = L.geoJson(data, {
                            style: style2(),
                            onEachFeature: function (feature, layer) {
                                layer.bindPopup(feature.properties.name);
                                layer._polygonId = feature.id;
                            },
                            filter: function (feature, layer) {
                                return $.inArray(feature.properties.name, districts) > -1;
                            }

                        });
                        geojson.addTo(map);
                    });
                });

            });

            $('#ips').on('change', function (data) {
                if (map.hasLayer(geojson)) {
                    map.removeLayer(geojson);
                }
                $.getJSON("/ip/" + $(this).val() + "/districts/", function (data) {
                    districts = data;
                    $.getJSON("/static/js/districts2.json", function (data) {
                        geojson = L.geoJson(data, {
                            style: style3(),
                            onEachFeature: function (feature, layer) {
                                layer.bindPopup(feature.properties.name);
                                layer._polygonId = feature.id;
                            },
                            filter: function (feature, layer) {
                                return $.inArray(feature.properties.name, districts) > -1;
                            }

                        });
                        geojson.addTo(map);
                    });
                });

            });


        }
        initmap();

    </script>
{% endblock %}